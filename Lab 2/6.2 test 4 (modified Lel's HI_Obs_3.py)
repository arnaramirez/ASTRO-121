import numpy as np
import ugradio
import os
import matplotlib.pyplot as plt
import time
import json

############################
# CONFIGURATION
############################

HI_FREQ = 1420.405751e6      # Hydrogen rest frequency (Hz)
c = 299792458                # Speed of light (m/s)

sample_rate = 2.4e6
nsamples_per_capture = 4096    # smaller chunks to prevent freezing
n_captures_per_integration = 4 # 4 x 4096 = 16384 per integration
gain = 40
freq_offset = 200e3

n_cal_integrations = 50
n_obs_integrations = 100
live_update_interval = 10

T_hot = 300
T_cold = 10

outdir = "data"
os.makedirs(outdir, exist_ok=True)

############################
# SETUP SDR
############################

sdr = ugradio.sdr.SDR(direct=False)
sdr.sample_rate = sample_rate
sdr.gain = gain

print("SDR configured (direct=False)")

############################
# FREQUENCY AXIS FUNCTION
############################

def make_freq_axis(lo_freq, nsamples_total):
    freqs = np.fft.fftshift(np.fft.fftfreq(nsamples_total, d=1/sample_rate))
    return freqs + lo_freq

############################
# INTEGRATION FUNCTION
############################

def integrate(lo_freq, n_integrations, label):

    sdr.center_freq = lo_freq
    nsamples_total = nsamples_per_capture * n_captures_per_integration
    avg_spec = np.zeros(nsamples_total)

    rf_freqs = make_freq_axis(lo_freq, nsamples_total)

    plt.ion()
    fig, ax = plt.subplots()
    line, = ax.plot(rf_freqs/1e6, avg_spec)
    ax.set_xlabel("Frequency (MHz)")
    ax.set_ylabel("Power (arb)")
    ax.set_title(label)

    for i in range(n_integrations):
        integration_spec = np.zeros(nsamples_total)

        # capture multiple small chunks per integration
        for j in range(n_captures_per_integration):
            samples = sdr.capture_data(nsamples_per_capture)

            # Flatten any extra dimensions
            if samples.ndim > 1:
                samples = samples.reshape(-1, nsamples_per_capture)
                fft = np.fft.fftshift(np.fft.fft(samples, axis=-1), axes=-1)
                power = np.abs(fft)**2
                spec = np.mean(power, axis=0)
            else:
                fft = np.fft.fftshift(np.fft.fft(samples))
                spec = np.abs(fft)**2

            # place into the correct portion of integration_spec
            start_idx = j * nsamples_per_capture
            integration_spec[start_idx:start_idx+nsamples_per_capture] = spec

            time.sleep(0.005)  # small pause to prevent SDR freeze

        avg_spec += integration_spec

        # live plot update
        if (i+1) % live_update_interval == 0:
            current_avg = avg_spec / (i+1)
            line.set_ydata(current_avg)
            ax.relim()
            ax.autoscale_view()
            plt.pause(0.01)
            print(f"{label}: {i+1}/{n_integrations}")

    plt.ioff()
    plt.show()

    return avg_spec / n_integrations

############################
# MAIN OBSERVATION FLOW
############################

try:

    print("\n=== COLD SKY CALIBRATION ===")
    input("Aim horn at cold sky and press Enter...")
    lo_cal = HI_FREQ - freq_offset
    s_cold = integrate(lo_cal, n_cal_integrations, "Cold Sky")

    print("\n=== HOT LOAD CALIBRATION ===")
    input("Place HOT load (person) in front of horn and press Enter...")
    s_hot = integrate(lo_cal, n_cal_integrations, "Hot Load")

    P_cold = np.mean(s_cold)
    P_hot = np.mean(s_hot)

    Y = P_hot / P_cold
    T_sys = (T_hot - Y*T_cold) / (Y - 1)

    print(f"\nY-factor: {Y:.4f}")
    print(f"System temperature: {T_sys:.2f} K")

    print("\n=== HYDROGEN OBSERVATION ===")
    input("Aim horn at zenith and press Enter...")

    lo_upper = HI_FREQ - freq_offset
    lo_lower = HI_FREQ + freq_offset

    spec_upper = integrate(lo_upper, n_obs_integrations, "HI Upper LO")
    spec_lower = integrate(lo_lower, n_obs_integrations, "HI Lower LO")

    diff_spec = spec_upper - spec_lower

    # Calibrate to antenna temperature
    T_ant = T_sys * (diff_spec / P_cold)

    rf_freqs = make_freq_axis(lo_upper, nsamples_per_capture * n_captures_per_integration)
    velocity = c * (HI_FREQ - rf_freqs) / HI_FREQ / 1000  # km/s

    ############################
    # METADATA
    ############################

    metadata = {
        "local_time": ugradio.timing.local_time(),
        "utc_time": ugradio.timing.utc(),
        "unix_time": ugradio.timing.unix_time(),
        "julian_date": ugradio.timing.julian_date(),
        "lst": ugradio.timing.lst(),
        "latitude": ugradio.nch.lat,
        "longitude": ugradio.nch.lon,
        "HI_rest_freq_Hz": HI_FREQ,
        "lo_upper_Hz": lo_upper,
        "lo_lower_Hz": lo_lower,
        "sample_rate_Hz": sample_rate,
        "gain_dB": gain,
        "nsamples_per_capture": nsamples_per_capture,
        "n_captures_per_integration": n_captures_per_integration,
        "n_cal_integrations": n_cal_integrations,
        "n_obs_integrations": n_obs_integrations,
        "T_sys_K": float(T_sys),
        "Y_factor": float(Y)
    }

    timestamp = int(time.time())

    np.savez(
        f"{outdir}/hi_observation_{timestamp}.npz",
        freq_Hz=rf_freqs,
        velocity_kms=velocity,
        temperature_K=T_ant,
        s_cold=s_cold,
        s_hot=s_hot,
        spec_upper=spec_upper,
        spec_lower=spec_lower,
        diff_spec=diff_spec
    )

    with open(f"{outdir}/metadata_{timestamp}.json", "w") as f:
        json.dump(metadata, f, indent=4)

    print("\nObservation complete and saved.")

except KeyboardInterrupt:
    print("\nUser interrupted safely.")

finally:
    sdr.close()
    print("SDR closed.")
